---
import Simple from "../../layouts/Simple.astro";

const CLOUDINARY_CLOUD_NAME = "dn2yh43vf"; // Replace with your Cloudinary cloud name

interface CloudinaryImage {
  public_id: string;
  url: string;
  secure_url: string;
  width: number;
  height: number;
  created_at: string;
  tags: string[];
  context?: {
    alt?: string;
    name?: string;
    description?: string;
    caption?: string;
    location?: string;
    camera?: string;
    film_stock?: string;
    lens?: string;
    collection?: string;
  };
}

let photos: CloudinaryImage[] = [];

try {
  // Fetch photos from Cloudinary
  // Note: This requires your API key to be set up as environment variables
  const response = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/resources/search`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Basic ${btoa(
          `${import.meta.env.CLOUDINARY_API_KEY}:${
            import.meta.env.CLOUDINARY_API_SECRET
          }`
        )}`,
      },
      body: JSON.stringify({
        expression: "tags=blog",
        max_results: 500,
        with_field: ["context", "tags"],
      }),
    }
  );

  if (response.ok) {
    const data = await response.json();
    photos = data.resources || [];
  }
} catch (error) {
  console.error("Failed to fetch photos from Cloudinary:", error);
}

// Sort photos by date (newest first)
photos.sort(
  (a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
);

// Group photos by collection
const photosByCollection = new Map();
photos.forEach((photo) => {
  const collection = photo.context?.collection || "Uncategorized";
  if (!photosByCollection.has(collection)) {
    photosByCollection.set(collection, []);
  }
  photosByCollection.get(collection).push(photo);
});

// Sort photos within each collection by location
photosByCollection.forEach((photos: CloudinaryImage[], collection: string) => {
  photos.sort((a: CloudinaryImage, b: CloudinaryImage) => {
    const locationA = a.context?.location || "zzz";
    const locationB = b.context?.location || "zzz";
    return locationA.localeCompare(locationB);
  });
});

// Collection metadata
interface CollectionMeta {
  description?: string;
  period?: string;
  location?: string;
}

const collectionInfo: Record<string, CollectionMeta> = {
  "Summer 2025": {
    description: "A collection of photos taken during the summer of 2025",
    period: "Summer 2025"
  },
  "First Fuji GS645S Shots": {
    description: "First shots taken with the Fuji GS645S camera. My first time shooting medium format and using a rangefinder.",
    period: "Summer 2025"
  },
  Scotland: {
    description:
      "Week-long trip exploring the Scottish Highlands and Edinburgh",
    period: "April 2025",
  },
  "Spring 2025": {
    period: "Spring 2025"
  },
  "Expired Kodak Royal Gold": {
    description: "Experimenting shooting with Kodak Royal Gold 400 film that expired in 1996",
    period: "Fall 2024",
  },
  "Catskills": {
    period: "Fall 2024",
  },
  "Summer 2024": {
    period: "Summer 2024"
  },
  "Spring 2024": {
    period: "Spring 2024"
  },
  "Honeymoon": {
    period: "Fall 2023"
  },
  "Summer 2023": {
    period: "Summer 2023"
  },
  "Fall 2022": {
    period: "Fall 2022"
  },
  "Pacific Northwest Adventures": {
    period: "Summer 2019"
  },
  "California": {
    period: "Spring 2019"
  },
  "OHIO": {
    period: "Summer 2018 - Summer 2019"
  },
  "Harpers Ferry": {
    period: "Summer 2019"
  },
  "Pit Stop in Pittsburgh": {
    period: "Spring 2019"
  },
  "A Post-Grad Weekend in DC": {
    period: "Summer 2018"
  },
  "Maine Fog": {
    period: "Summer 2018"
  },
  "Backpacking Around Europe": {
    period: "Summer 2018",
    description: "First photos I ever took on film!"
  },

};

// Function to parse period into sortable date
function parseperiod(period: string | undefined): Date {
  if (!period) return new Date(0); // Very old date for collections without period
  
  // Handle formats like "April 2025", "Summer 2024", "2023", "December 2022"
  const normalized = period.toLowerCase().trim();
  
  // Try to extract year first
  const yearMatch = normalized.match(/(\d{4})/);
  if (!yearMatch) return new Date(0);
  
  const year = parseInt(yearMatch[1]);
  
  // Month mapping
  const monthMap: Record<string, number> = {
    january: 0, jan: 0,
    february: 1, feb: 1,
    march: 2, mar: 2,
    april: 3, apr: 3,
    may: 4,
    june: 5, jun: 5,
    july: 6, jul: 6,
    august: 7, aug: 7,
    september: 8, sep: 8, sept: 8,
    october: 9, oct: 9,
    november: 10, nov: 10,
    december: 11, dec: 11,
    // Seasons (approximate middle months)
    spring: 3,
    summer: 6,
    fall: 9, autumn: 9,
    winter: 0
  };
  
  // Look for month/season
  for (const [name, monthIndex] of Object.entries(monthMap)) {
    if (normalized.includes(name)) {
      return new Date(year, monthIndex);
    }
  }
  
  // If just year, use middle of year
  return new Date(year, 6);
}

// Convert to array and sort collections
const collections: [string, CloudinaryImage[]][] = Array.from(photosByCollection.entries()).sort((a, b) => {
  // Put 'Uncategorized' last
  if (a[0] === "Uncategorized") return 1;
  if (b[0] === "Uncategorized") return -1;
  
  // Sort by period (newest first)
  const periodA = collectionInfo[a[0]]?.period;
  const periodB = collectionInfo[b[0]]?.period;
  
  const dateA = parseperiod(periodA);
  const dateB = parseperiod(periodB);
  
  // Newest first (descending order)
  return dateB.getTime() - dateA.getTime();
});

// Prepare photos data for client-side JavaScript in collection order
const photosData = [];
for (const [collectionName, collectionPhotos] of collections) {
  for (const photo of collectionPhotos) {
    photosData.push({
      public_id: photo.public_id,
      secure_url: photo.secure_url,
      context: photo.context || {},
    });
  }
}
---

<Simple title="Noah Gorstein | Photos">
  <main class="container mx-auto px-4 py-8 md:px-8">
    <div class="mx-auto max-w-[1400px]">
      <!-- Page Header -->
      <div class="mb-12">
        <h1 class="mb-4 text-4xl font-bold">Photos</h1>
        <p class="text-lg opacity-75">Bunch of photos I've taken on film over the years.</p>

        <!-- TOC for small screens -->
        {
          collections.length > 1 && (
            <nav class="mt-8 inline-block rounded-xl border border-foreground/10 bg-background p-6 shadow-sm xl:hidden">
              <h3 class="mb-4 text-lg font-semibold">Collections</h3>
              <ul class="space-y-3">
                {collections.map(([collectionName, collectionPhotos]) => (
                  <li>
                    <a
                      href={`#${collectionName
                        .toLowerCase()
                        .replace(/\s+/g, "-")}`}
                      class="toc-link block py-1 text-sm text-foreground/70 transition-colors hover:text-foreground"
                      data-target={collectionName
                        .toLowerCase()
                        .replace(/\s+/g, "-")}
                    >
                      {collectionName}
                    </a>
                  </li>
                ))}
              </ul>
            </nav>
          )
        }
      </div>

      <!-- Main layout with sidebar -->
      <div class="flex gap-8 xl:gap-12">
        <!-- Photos content -->
        <section class="min-w-0 flex-1">
          {
            photos.length === 0 ? (
              <div class="py-12 text-center">
                <p class="text-lg opacity-50">No photos found. Make sure to:</p>
                <ul class="mt-4 space-y-2 text-sm opacity-75">
                  <li>1. Set up your Cloudinary account</li>
                  <li>
                    2. Add CLOUDINARY_API_KEY and CLOUDINARY_API_SECRET to your
                    .env file
                  </li>
                  <li>3. Update CLOUDINARY_CLOUD_NAME in this file</li>
                  <li>4. Upload photos with the "blog" tag</li>
                  <li>5. Add "collection" metadata to group your photos</li>
                </ul>
              </div>
            ) : (
              <div class="space-y-16">
                {collections.map(([collectionName, collectionPhotos]) => {
                  let photoIndex = 0;
                  // Calculate the starting index for this collection
                  for (const [prevName] of collections) {
                    if (prevName === collectionName) break;
                    photoIndex += photosByCollection.get(prevName).length;
                  }

                  const info = collectionInfo[collectionName] || {};

                  return (
                    <section
                      id={collectionName.toLowerCase().replace(/\s+/g, "-")}
                      class="collection-section"
                    >
                      <div class="mb-8">
                        <h2 class="group mb-2 text-2xl font-bold">
                          <a 
                            href={`#${collectionName.toLowerCase().replace(/\s+/g, "-")}`}
                            class="hover:text-accent transition-colors"
                          >
                            {collectionName}
                            <span class="ml-2 opacity-0 group-hover:opacity-100 transition-opacity text-lg">#</span>
                          </a>
                        </h2>

                        {info.description && (
                          <p class="mb-3 text-base opacity-80">
                            {info.description}
                          </p>
                        )}

                        {(info.period || info.location) && (
                          <div class="mb-2 flex flex-wrap gap-4 text-sm opacity-60">
                            {info.period && <span>üìÖ {info.period}</span>}
                            {info.location && <span>üìç {info.location}</span>}
                          </div>
                        )}

                        <p class="text-xs opacity-50">
                          {collectionPhotos.length}{" "}
                          {collectionPhotos.length === 1 ? "photo" : "photos"}
                        </p>
                      </div>

                      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                        {collectionPhotos.map((photo, localIndex) => {
                          const globalIndex = photoIndex + localIndex;
                          return (
                            <div
                              class="photo-item group relative cursor-pointer overflow-hidden rounded-lg border-2 border-foreground/10 transition-colors hover:border-accent"
                              data-index={globalIndex}
                            >
                              <div class="aspect-square overflow-hidden">
                                <img
                                  src={`${photo.secure_url.replace(
                                    "/upload/",
                                    "/upload/c_fill,w_400,h_400,q_auto,f_auto/"
                                  )}`}
                                  alt={
                                    photo.context?.alt ||
                                    `Photo ${photo.public_id}`
                                  }
                                  class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                                  loading="lazy"
                                />
                              </div>

                              {(photo.context?.name ||
                                photo.context?.description ||
                                photo.context?.caption ||
                                photo.context?.camera ||
                                photo.context?.film_stock) && (
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                                  {photo.context.name && (
                                    <p class="text-sm font-bold text-white">
                                      {photo.context.name}
                                    </p>
                                  )}
                                  {photo.context.description && (
                                    <p class="mt-1 text-sm text-white/90">
                                      {photo.context.description}
                                    </p>
                                  )}
                                  {photo.context.caption && (
                                    <p class="mt-1 text-sm font-medium text-white">
                                      {photo.context.caption}
                                    </p>
                                  )}
                                  {photo.context.location && (
                                    <p class="mt-1 text-xs text-white/75">
                                      üìç {photo.context.location}
                                    </p>
                                  )}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </section>
                  );
                })}
              </div>
            )
          }
        </section>

        <!-- Sticky TOC Sidebar for large screens -->
        {
          collections.length > 1 && (
            <aside class="hidden w-64 flex-shrink-0 xl:block">
              <nav class="sticky top-8 rounded-xl border border-foreground/10 bg-background p-6 shadow-sm">
                <h3 class="mb-4 text-lg font-semibold">Collections</h3>
                <ul class="space-y-1">
                  {collections.map(([collectionName, collectionPhotos]) => (
                    <li>
                      <a
                        href={`#${collectionName
                          .toLowerCase()
                          .replace(/\s+/g, "-")}`}
                        class="toc-link block py-1 text-sm text-foreground/70 transition-colors hover:text-foreground"
                        data-target={collectionName
                          .toLowerCase()
                          .replace(/\s+/g, "-")}
                      >
                        {collectionName}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </aside>
          )
        }
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div
    id="photoModal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 p-4"
    data-photos={JSON.stringify(photosData)}
  >
    <div
      class="relative flex h-full max-h-screen w-full max-w-screen-xl items-center justify-center"
    >
      <!-- Close button -->
      <button
        id="closeModalBtn"
        class="absolute right-4 top-4 z-10 flex h-10 w-10 items-center justify-center rounded-full bg-black/50 text-2xl text-white transition-colors hover:bg-black/70"
      >
        √ó
      </button>

      <!-- Image -->
      <img
        id="modalImage"
        src=""
        alt=""
        class="max-h-full max-w-full object-contain"
      />

      <!-- Metadata overlay -->
      <div
        id="modalMetadata"
        class="absolute bottom-4 left-4 right-4 rounded-lg bg-black/80 p-4 text-white"
      >
      </div>
    </div>
  </div>
</Simple>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const photoModalEl = document.getElementById("photoModal");
    const photos: any[] = photoModalEl && photoModalEl.getAttribute("data-photos")
      ? JSON.parse(photoModalEl.getAttribute("data-photos") as string)
      : [];

    function openModal(index: number) {
      const modal = document.getElementById("photoModal");
      const modalImage = document.getElementById("modalImage") as HTMLImageElement | null;
      const modalMetadata = document.getElementById("modalMetadata");
      const photo = photos[index];

      if (!modal || !modalImage || !modalMetadata) return;

      // Set image with original aspect ratio and higher quality
      modalImage.src = photo.secure_url.replace(
        "/upload/",
        "/upload/q_auto,f_auto,w_1200/"
      );
      modalImage.alt = photo.context?.alt || `Photo ${photo.public_id}`;

      // Build metadata HTML
      let metadataHTML = "";
      if (photo.context?.name) {
        metadataHTML += `<p class="text-lg font-bold">${photo.context.name}</p>`;
      }
      if (photo.context?.description) {
        metadataHTML += `<p class="mt-1 text-sm opacity-90">${photo.context.description}</p>`;
      }
      if (
        photo.context?.location ||
        photo.context?.camera ||
        photo.context?.film_stock ||
        photo.context?.lens
      ) {
        metadataHTML +=
          '<div class="mt-2 flex flex-wrap gap-x-4 gap-y-1 text-xs opacity-75">';
        if (photo.context.location)
          metadataHTML += `<span>üìç ${photo.context.location}</span>`;
        if (photo.context.camera)
          metadataHTML += `<span>üì∑ ${photo.context.camera}</span>`;
        if (photo.context.film_stock)
          metadataHTML += `<span>üéûÔ∏è ${photo.context.film_stock}</span>`;
        if (photo.context.lens)
          metadataHTML += `<span>üîç ${photo.context.lens}</span>`;
        metadataHTML += "</div>";
      }

      modalMetadata.innerHTML = metadataHTML;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function closeModal() {
      const modal = document.getElementById("photoModal");
      if (!modal) return;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    // Add click listeners to photo items
    document.querySelectorAll(".photo-item").forEach(function (item) {
      item.addEventListener("click", function (this: HTMLElement) {
        const index = parseInt(this.getAttribute("data-index") || "0", 10);
        openModal(index);
      });
    });

    // Close modal on escape key
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        closeModal();
      }
    });

    // Close modal when clicking outside the image
    const photoModal = document.getElementById("photoModal");
    if (photoModal) {
      photoModal.addEventListener("click", function (e) {
        if (e.target === this) {
          closeModal();
        }
      });
    }

    // Close button
    const closeModalBtn = document.getElementById("closeModalBtn");
    if (closeModalBtn) {
      closeModalBtn.addEventListener("click", closeModal);
    }

    // TOC scroll tracking
    const tocLinks = Array.from(document.querySelectorAll(".toc-link")) as HTMLElement[];
    const sections = Array.from(document.querySelectorAll(".collection-section"));

    function updateActiveTocLink() {
      let currentSection = "";

      sections.forEach((section) => {
        const rect = section.getBoundingClientRect();
        if (rect.top <= 100 && rect.bottom >= 100) {
          currentSection = (section as HTMLElement).id;
        }
      });

      tocLinks.forEach((link) => {
        if ((link.dataset && link.dataset.target === currentSection)) {
          link.classList.add("text-accent", "font-medium");
          link.classList.remove("text-foreground/70");
        } else {
          link.classList.add("text-foreground/70");
          link.classList.remove("text-accent", "font-medium");
        }
      });
    }

    // Update on scroll
    window.addEventListener("scroll", updateActiveTocLink);
    // Initial update
    updateActiveTocLink();
  });
</script>
